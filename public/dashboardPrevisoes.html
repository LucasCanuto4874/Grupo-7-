<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/cssPrevisoes.css">
    <title>Dashboard Previsões Rebeca</title>
    <!-- Carregando a biblioteca do Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="listarServidor()">

    <div class="pai" id="div_pai">
        <div class="NavBar">
            <div>
                <img class="LogoNavBar" src="./assets/Logo Quantum.svg" alt="">
            </div>
            <div class="div1">
                <a class="botaoNavBar" href="">Home</a>
                <a class="botaoNavBar" href="">Previsões</a>
                <a class="botaoNavBar" href="">Funcionário</a>
                <a class="botaoNavBar" href="">Servidor</a>
                <a class="botaoNavBar" href="">Perfil</a>
            </div>
        </div>

        <div class="alinha">
            <div class="previsao">
                <h2>Previsões</h2>
                <p>Monitoramento da semana <br> 04/11/24 - 10/11/24</p>
            </div>
            <div class="mediaepico">
                <div class="media">
                    <h3> Média de uso - RAM e CPU</h3>
                    <p style="font-size: x-small;">Clique no ícone para vizualizar a média por servidor</p>
                    <div class="componentes">
                        <img style="padding: 5px;" src="img/svgRam.svg" alt="Ícone RAM" onclick="aparecerMediaRam(), listarmediaRam()">
                        <img style="padding: 5px;" src="img/svgCpu.svg" alt="Ícone CPU" onclick="aparecerMediaCpu(), listarmediaCpu()">
                    </div>
                </div>
                <div class="media">
                    <h3> Pico de uso - RAM e CPU</h3>
                    <p style="font-size: x-small;">Clique no ícone para vizualizar o pico de uso por servidor</p>
                    <div class="componentes">
                        <img style="padding: 5px;" src="img/svgRam.svg" alt="Ícone RAM" onclick="aparecerPicoRam(), listarpicoRam()">
                        <img style="padding: 5px;" src="img/svgCpu.svg" alt="Ícone CPU" onclick="aparecerPicoCpu(), listarpicoCpu()">
                    </div>
                </div>
            </div>
        </div>

        <div class="abaixo">
            <div class="ranking">
                <h4>Servidores mais críticos em relação ao downtime
                    <hr>
                </h4>
                <div class="listaRanking">
                    <table>
                        <thead>
                            <tr class="table-header">
                                <th>Servidor</th>
                                <th>Tempo de dowtime semanal</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>


            <div class="MapaCalor">
                <h4>Previsão de downtime para a próxima semana
                    <hr>
                </h4>
                <div class="graficoMapaDeCalor" id="chart"></div>
            </div>

            <div class="tendencia">
                <h4>Tendência de uso dos servidores
                    <hr>
                </h4>
                <div class="alinha-select">
                    <div class="select-server" id="select-server"></div>
                    <div id="select-componente"></div>
                </div>

                <div class="graficoTendencia">
                    <canvas id="myChart"
                        style="height: 350px; width: 460px; text-align: center; padding-left: 15px; padding-top: 16px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mediaRam" id="mediaRam">
        <h4>Média de uso de memória RAM nessa semana
            <hr>
        </h4>
        <div class="listamediaRam">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>Média RAM</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderMediaRam()" class="fechar">Fechar</button>
    </div>

    <div class="mediaCpu" id="mediaCpu">
        <h4>Média de uso de memória CPU nessa semana
            <hr>
        </h4>
        <div class="listamediaCpu">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>Média CPU</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderMediaCpu()" class="fechar">Fechar</button>
    </div>

    <div class="picoRam" id="picoRam">
        <h4>Pico de uso de memória RAM nessa semana
            <hr>
        </h4>
        <div class="listapicoRam">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>Pico mais alto RAM</th>
                        <th>Pico mais baixo RAM</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderPicoRam()" class="fechar">Fechar</button>
    </div>

    <div class="picoCpu" id="picoCpu">
        <h4>Pico de uso de memória CPU nessa semana
            <hr>
        </h4>
        <div class="listapicoCpu">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>Pico mais alto CPU</th>
                        <th>Pico mais baixo CPU</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderPicoCpu()" class="fechar">Fechar</button>
    </div>

</body>

<script src="js/dashPrevisao.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    //  LISTAGEM SELECT DE SERVIDOR
    function listarSelect() {
        fetch(`/previsao/buscarPorId`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Transformando a resposta em JSON
            })
            .then(data => {
                console.log(data); // Verifique no console se a resposta está conforme esperado

                const selectDiv = document.getElementById('select-server');
                selectDiv.innerHTML = ''; // Limpar conteúdo anterior da div

                if (!data || data.length === 0) {  // Verificar se data é nulo ou um array vazio
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'Nenhum Registro encontrado.';
                    noDataMessage.style.color = '#fff';
                    noDataMessage.style.textAlign = 'center';
                    selectDiv.appendChild(noDataMessage);
                } else {
                    // Cria o elemento select
                    const selectElement = document.createElement('select');
                    selectElement.classList.add('custom-select'); // Adiciona uma classe CSS, se necessário

                    // Adiciona a opção padrão
                    selectElement.innerHTML = `<option value="" disabled selected>Selecione um servidor</option>`;

                    // Percorrer os dados e adicionar as opções
                    data.forEach(item => {
                        // Adicionar uma opção ao select
                        selectElement.innerHTML += `
                        <option value="${item.idServidor}">
                            ${item.nomeServidor}
                        </option>
                    `;
                    });

                    // Adiciona o select na div
                    selectDiv.appendChild(selectElement);
                    selectElement.addEventListener('change', () => {
                        // Obtém os valores selecionados dinamicamente
                        const servidorSelecionado = selectElement.value; // Valor do servidor selecionado
                        const componenteSelecionado = document
                            .getElementById('select-componente')
                            .querySelector('select')?.value; // Valor do componente selecionado (se existir)

                        console.log('Servidor Selecionado:', servidorSelecionado);
                        console.log('Componente Selecionado:', componenteSelecionado);

                        // Verifica se ambos os valores estão definidos antes de chamar a função
                        if (servidorSelecionado && componenteSelecionado) {
                            criarGrafico(servidorSelecionado, componenteSelecionado);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Houve um erro ao capturar os dados:', error);

                // Exibe uma mensagem de erro
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Erro ao carregar os servidores.';
                errorMessage.style.color = '#ff0000';
                errorMessage.style.textAlign = 'center';
                document.getElementById('select-server').appendChild(errorMessage);
            });
    }

    // Chama a função para listar os servidores ao carregar a página
    listarSelect();

    // LISTAGEM DE COMPONENTE
    function listarComponente() {
        fetch(`/previsao/buscarComponente`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Transformando a resposta em JSON
            })
            .then(data => {
                console.log(data); // Verifique no console se a resposta está conforme esperado

                const selectDiv = document.getElementById('select-componente');
                selectDiv.innerHTML = ''; // Limpar conteúdo anterior da div

                if (!data || data.length === 0) {  // Verificar se data é nulo ou um array vazio
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'Nenhum Registro encontrado.';
                    noDataMessage.style.color = '#fff';
                    noDataMessage.style.textAlign = 'center';
                    selectDiv.appendChild(noDataMessage);
                } else {
                    // Cria o elemento select
                    const selectElement = document.createElement('select');
                    selectElement.classList.add('custom-select'); // Adiciona uma classe CSS, se necessário

                    // Adiciona a opção padrão
                    selectElement.innerHTML = `<option value="" disabled selected>Selecione um componente</option>`;

                    // Percorrer os dados e adicionar as opções
                    data.forEach(item => {
                        // Adicionar uma opção ao select
                        selectElement.innerHTML += `
                        <option value="${item.idComponente}">
                            ${item.nome}
                        </option>
                    `;
                    });

                    // Adiciona o select na div
                    selectDiv.appendChild(selectElement);
                    selectElement.addEventListener('change', () => {
                        // Obtém os valores selecionados dinamicamente
                        const servidorSelecionado = document
                            .getElementById('select-server')
                            .querySelector('select')?.value; // Valor do servidor selecionado (se existir)
                        const componenteSelecionado = selectElement.value; // Valor do componente selecionado

                        console.log('Servidor Selecionado:', servidorSelecionado);
                        console.log('Componente Selecionado:', componenteSelecionado);

                        // Verifica se ambos os valores estão definidos antes de chamar a função
                        if (servidorSelecionado && componenteSelecionado) {
                            criarGrafico(servidorSelecionado, componenteSelecionado);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Houve um erro ao capturar os dados:', error);

                // Exibe uma mensagem de erro
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Erro ao carregar os servidores.';
                errorMessage.style.color = '#ff0000';
                errorMessage.style.textAlign = 'center';
                document.getElementById('select-componente').appendChild(errorMessage);
            });
    }

    // Chama a função para listar os servidores ao carregar a página
    listarComponente();



    async function obterDadosDoBanco(servidorId, componenteId) {
        console.log('servidor:', servidorId)
        console.log('componente:', componenteId)

        try {
            let response = await fetch(`/previsao/buscarTendenciaUsoRam/${componenteId}/${servidorId}`);
            let data = await response.json();  // Convertendo a resposta em JSON
            console.log(data)
            return data;  // Retorna os dados para uso posterior
        } catch (error) {
            console.error('Erro ao obter dados:', error);
            return [];  // Retorna um array vazio em caso de erro
        }
    }


    // Função de regressão linear (já explicada anteriormente)
    function calcularRegressao(data) {
        const n = data.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

        data.forEach(point => {
            sumX += point.x;
            sumY += point.y;
            sumXY += point.x * point.y;
            sumXX += point.x * point.x;
        });

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        return { slope, intercept };
    }

    let graficoAtivo = null;
    async function criarGrafico(servidorId, componenteId) {

        const servidorSelecionado = document.querySelector('#select-server select')?.value; // Pega o value do select de servidor
        const componenteSelecionado = document.querySelector('#select-componente select')?.value; // Pega o value do select de componente

        console.log('Servidor Selecionado CRIAR GRÁFICO:', servidorSelecionado);
        console.log('Componente Selecionado CRIAR GRÁFICO:', componenteSelecionado);

        if (!servidorSelecionado || !componenteSelecionado) {
            return; // Não cria o gráfico se um dos selects não estiver selecionado }
        }
        const dadosRam = await obterDadosDoBanco(servidorSelecionado, componenteSelecionado);
        const arrayDados = Object.entries(dadosRam).map(([chave, valor]) => `${chave}: ${valor}`);


        // Transforma os dados para o formato necessário (x: dia da semana, y: uso de RAM)
        const scatterData = dadosRam.map((dado, index) => ({
            x: index + 4,  // Usando o índice como valor de 'x' (dias da semana)
            y: dado.media_uso_ram
        }));

        // Calcula a linha de regressão linear
        const { slope, intercept } = calcularRegressao(scatterData);

        // Gere os pontos da linha de regressão
        const regressionLine = scatterData.map(point => ({
            x: point.x,
            y: slope * point.x + intercept
        }));

        if (graficoAtivo) {
            graficoAtivo.destroy();
        }

        // Para que resetar as configurações do card onde está o gráfico
        const canvasContainer = document.querySelector('.graficoTendencia');
        canvasContainer.innerHTML = '<canvas id="myChart" style="height: 350px; width: 460px;"></canvas>';
        let nomeComponente = componenteSelecionado === '1' ? 'CPU' : 'RAM'; // Usa comparação e operador ternário para maior clareza

        // Criação do gráfico com Chart.js
        const ctx = document.getElementById('myChart').getContext('2d');
        graficoAtivo = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        color: 'rgba(255, 255, 255, 1)',

                        label: `Uso de ${nomeComponente}`,
                        data: scatterData,
                        backgroundColor: 'red',
                    },
                    {
                        label: 'Tendência de Uso',
                        data: regressionLine,
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 0.8)',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0  // Remove os pontos da linha de regressão
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            color: 'rgba(255, 255, 255, 1)',
                            text: 'Dia da Semana'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 1)',
                            callback: function (value) {
                                const dias = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
                                return dias[value - 1]; // Ajusta para os dias da semana
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 1)', // Cor branca para a linha de grade no eixo X
                        },
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 1)', // Cor branca para a linha de grade no eixo Y
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 1)' // Cor branca para os números no eixo Y
                        },
                        title: {
                            display: true,
                            text: `Uso de ${nomeComponente} (%)`,
                            color: 'rgba(255, 255, 255, 1)',
                            font: {
                                size: 15
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: 'rgba(255, 255, 255, 1)',// Cor das letras das legendas
                            font: {
                                size: 16 // Tamanho da fonte
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</html>