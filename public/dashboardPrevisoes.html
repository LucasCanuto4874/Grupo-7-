<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/cssPrevisoes.css">
    <link rel="icon" href="img/novalogo.svg" type="image/x-icon">
    <title>Dashboard Previs√µes Rebeca</title>
    <!-- Carregando a biblioteca do Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="listarServidor()">

    <div class="pai" id="div_pai">
        <div class="NavBar">
            <div>
                <img class="LogoNavBar" src="./assets/Logo Quantum.svg" alt="">
            </div>
            <div class="div1">
                <a class="botaoNavBar" href="">Home</a>
                <a class="botaoNavBar" href="">Previs√µes</a>
                <a class="botaoNavBar" href="">Funcion√°rio</a>
                <a class="botaoNavBar" href="">Servidor</a>
                <a class="botaoNavBar" href="">Perfil</a>
            </div>
        </div>

        <div class="alinha">
            <div class="previsao">
                <h2>Previs√µes</h2>
                <p style="font-size: large; font-weight: bold;">Monitoramento da semana <br> 04/11/24 - 10/11/24</p>
            </div>

            <div class="oee" id="oee">
                <div style="display: flex; justify-content: space-between; padding: 10px; margin: 0px;">
                    <div class="tooltip">
                        <div class="icon" style="margin-top: 10px;">i</div>
                        <div class="tooltiptext">
                            <p>O OEE Overall Equipment Effectiveness ou Efici√™ncia Geral dos Equipamentos, √© um indicador amplamente utilizado na gest√£o de desempenho para medir a
                               capacidade operacional e efici√™ncia de m√°quinas.</p>
                            <!-- <p>O resultado do OEE √© dado com a multiplica√ß√£o de: Disponibilidade(Tempo de opera√ß√£o
                                planejado - Tempo de parada planejado / Tempo de opera√ß√£o planejado) vezes
                                Desempenho(Tempo real de produ√ß√£o/ Tempo disponivel)</p> -->
                            <p>100% OEE: Opera√ß√£o ideal (tempo dispon√≠vel total, sem perdas e produtos 100% conforme).
                                85% OEE ou mais: Excelente, indicando um n√≠vel de opera√ß√£o eficiente (meta para
                                opera√ß√µes de classe mundial).
                                60%-85% OEE: Regular, com espa√ßo para melhorias.
                                Abaixo de 60%: Ineficiente, indicando problemas significativos que precisam ser
                                corrigidos.</p>
                            <p><strong>Para Que Utilizar:</strong> 
                                Identificar gargalos no sistema.
                                Priorizar melhorias em √°reas cr√≠ticas, como paradas frequentes ou baixa qualidade.
                                Monitorar a efici√™ncia ao longo do tempo para acompanhar o impacto das mudan√ßas.</p>
                        </div>
                    </div>
                    <h4 style="color: white; margin: 5px;">C√°lculo do OEE</h4>
                    <div id="select-oee"> </div>

                </div>
                <div class="alinhar-oee" style="display: flex; justify-content: space-between;">
                    <div style="margin-right: 20px;">
                        <p><strong>Tempo Dispon√≠vel:</strong> 168 horas</p>
                        <p><strong>Tempo Produtivo:</strong> 164 horas</p>
                        <p><strong>Efici√™ncia estimada:</strong> 97,62%</p>
                    </div>
                    <div style="text-align: center; font-size: large; border: 1px solid rgb(57, 31, 84); padding: 0; margin: 0;">
                        <p><strong>Resultado OEE:</strong></p>
                        <p id="oks" style="font-size: xx-large; margin: 0;"></p>
                    </div>
                </div>

            </div>

            <div class="mediaepico">
                <div class="media">
                    <h3> M√©dia de uso <br> RAM e CPU</h3>
                    <p style="font-size: x-small;">Clique no √≠cone para vizualizar a m√©dia por servidor</p>
                    <div class="componentes">
                        <img style="padding: 5px;" src="img/svgRam.svg" alt="√çcone RAM"
                            onclick="aparecerMediaRam(), listarmediaRam()">
                        <img style="padding: 5px;" src="img/svgCpu.svg" alt="√çcone CPU"
                            onclick="aparecerMediaCpu(), listarmediaCpu()">
                    </div>
                </div>
                <div class="media">
                    <h3> Pico de uso <br> RAM e CPU</h3>
                    <p style="font-size: x-small;">Clique no √≠cone para vizualizar o pico de uso por servidor</p>
                    <div class="componentes">
                        <img style="padding: 5px;" src="img/svgRam.svg" alt="√çcone RAM"
                            onclick="aparecerPicoRam(), listarpicoRam()">
                        <img style="padding: 5px;" src="img/svgCpu.svg" alt="√çcone CPU"
                            onclick="aparecerPicoCpu(), listarpicoCpu()">
                    </div>
                </div>
            </div>
        </div>

        <div class="abaixo">
            <div class="ranking">
                <h4>Servidores mais cr√≠ticos em rela√ß√£o ao downtime
                    <div class="tooltip">
                        <div class="icon">i</div>
                        <div class="tooltiptext">
                            <p>Estado Cr√≠tico üî¥: Um servidor √© considerado em estado cr√≠tico quando o tempo de downtime
                                √© muito alto ou a frequ√™ncia de falhas √© recorrente. Esse estado indica que o servidor
                                est√° impactando as opera√ß√µes, podendo levar a interrup√ß√µes do servi√ßo PEP.</p>
                            <p>Estado de Alerta üü°: O estado de alerta √© ativado quando o tempo de downtime √© moderado,
                                mas ainda pode ser motivo de preocupa√ß√£o. Embora n√£o haja impacto imediato, o servidor
                                precisa ser monitorado de perto. A interven√ß√£o pode ser necess√°ria para evitar que o
                                problema se agrave.</p>
                            <p>Estado Normal üü¢: O estado normal √© quando o servidor n√£o apresenta problemas
                                significativos de downtime e est√° operando dentro dos par√¢metros esperados. Manuten√ß√£o
                                regular e monitoramento s√£o suficientes para garantir sua opera√ß√£o.</p>
                            <p><strong>Como Utilizar As Categorias:</strong> Servidores cr√≠ticos exigem corre√ß√£o
                                imediata, os em alerta precisam de acompanhamento pr√≥ximo e os normais requerem
                                monitoramento regular para preven√ß√£o.</p>
                        </div>
                    </div>
                    <hr>
                </h4>
                <div class="listaRanking">
                    <table>
                        <thead>
                            <tr class="table-header">
                                <th>Servidor</th>
                                <th>Tempo de dowtime semanal</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>


            <div class="MapaCalor">
                <h4 style="font-family: Arial, Helvetica, sans-serif;">Previs√£o de downtime para a pr√≥xima semana
                    <div class="tooltip">
                        <div class="icon">i</div>
                        <div class="tooltiptext">
                            <p>Os dias com maior probabilidade de downtime s√£o destacados com uma cor mais escura,
                                enquanto dias de menor probabilidade possuem uma cor mais clara.</p>
                            <p>Esse indicador permite que o time de infraestrutura se prepare para per√≠odos cr√≠ticos,
                                garantindo o planejamento adequado para mitigar os efeitos dos downtimes previstos.</p>
                            <p><strong>Dica:</strong> Verifique se h√° padr√µes consistentes, como downtimes frequentes
                                nos mesmos dias da semana ou hor√°rios espec√≠ficos. Isso pode indicar uma sobrecarga
                                previs√≠vel ou problemas de manuten√ß√£o.</p>
                            <p><strong>Uso do gr√°fico:</strong> Servidores com downtime elevado em per√≠odos prolongados
                                indicam poss√≠veis problemas de hardware ou necessidade de atualiza√ß√£o de recursos.</p>
                        </div>
                    </div>
                    <hr>
                </h4>
                <div class="graficoMapaDeCalor" id="chart"></div>
            </div>

            <div class="tendencia">
                <h4>Tend√™ncia de uso dos servidores
                    <div class="tooltip">
                        <div class="icon">i</div>
                        <div class="tooltiptext">
                            <p>Observe a Linha de Uso Atual:
                                A linha vermelha indica o uso real do componente em diferentes momentos. Valores
                                pr√≥ximos de 100% podem indicar que o servidor est√° sobrecarregado, enquanto valores
                                muito baixos podem sugerir subutiliza√ß√£o.</p>
                            <p>A linha representa a tend√™ncia prevista para o uso do componente. Essa previs√£o pode
                                ajudar a identificar picos de demanda futuros e per√≠odos de uso reduzido.</p>
                            <p><strong>Dica:</strong> Se a linha de tend√™ncia √© plana, o uso est√° est√°vel. Se √©
                                inclinada, pode haver varia√ß√µes significativas no desempenho esperado.</p>
                            <p><strong>Obs:</strong> Se houver per√≠odos de uso baixo considere otimizar os recursos,
                                realocando outras tarefas para esse servidor.</p>
                        </div>
                    </div>
                    <hr>
                </h4>
                <div class="alinha-select">
                    <div class="select-server" id="select-server"></div>
                    <div id="select-componente"></div>
                </div>
                <div class="graficoTendencia">
                    <br>
                    √â necess√°rio selecionar um servidor e componente para que o gr√°fico apareca
                    <canvas id="myChart"
                        style="height: 350px; width: 460px; text-align: center; padding-left: 15px; padding-top: 16px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mediaRam" id="mediaRam">
        <h4>M√©dia de uso de mem√≥ria RAM nessa semana
            <hr>
        </h4>
        <div class="listamediaRam">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>M√©dia RAM</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderMediaRam()" class="fechar">Fechar</button>
    </div>

    <div class="mediaCpu" id="mediaCpu">
        <h4>M√©dia de uso de mem√≥ria CPU nessa semana
            <hr>
        </h4>
        <div class="listamediaCpu">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>M√©dia CPU</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderMediaCpu()" class="fechar">Fechar</button>
    </div>

    <div class="picoRam" id="picoRam">
        <h4>Pico de uso de mem√≥ria RAM nessa semana
            <hr>
        </h4>
        <div class="listapicoRam">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>Pico mais alto RAM</th>
                        <th>Pico mais baixo RAM</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderPicoRam()" class="fechar">Fechar</button>
    </div>

    <div class="picoCpu" id="picoCpu">
        <h4>Pico de uso de mem√≥ria CPU nessa semana
            <hr>
        </h4>
        <div class="listapicoCpu">
            <table>
                <thead>
                    <tr class="table-header">
                        <th>Servidor</th>
                        <th>Pico mais alto CPU</th>
                        <th>Pico mais baixo CPU</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <button onclick="esconderPicoCpu()" class="fechar">Fechar</button>
    </div>

</body>

<script src="js/dashPrevisao.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    //  LISTAGEM SELECT DE SERVIDOR
    function listarSelect() {
        fetch(`/previsao/buscarPorId`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Transformando a resposta em JSON
            })
            .then(data => {
                console.log(data); // Verifique no console se a resposta est√° conforme esperado

                const selectDiv = document.getElementById('select-server');
                selectDiv.innerHTML = ''; // Limpar conte√∫do anterior da div

                if (!data || data.length === 0) {  // Verificar se data √© nulo ou um array vazio
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'Nenhum Registro encontrado.';
                    noDataMessage.style.color = '#fff';
                    noDataMessage.style.textAlign = 'center';
                    selectDiv.appendChild(noDataMessage);
                } else {
                    // Cria o elemento select
                    const selectElement = document.createElement('select');
                    selectElement.classList.add('custom-select'); // Adiciona uma classe CSS, se necess√°rio

                    // Adiciona a op√ß√£o padr√£o
                    selectElement.innerHTML = `<option value="" disabled selected>Selecione um servidor</option>`;

                    // Percorrer os dados e adicionar as op√ß√µes
                    data.forEach(item => {
                        // Adicionar uma op√ß√£o ao select
                        selectElement.innerHTML += `
                        <option value="${item.idServidor}">
                            ${item.nomeServidor}
                        </option>
                    `;
                    });

                    // Adiciona o select na div
                    selectDiv.appendChild(selectElement);
                    selectElement.addEventListener('change', () => {
                        // Obt√©m os valores selecionados dinamicamente
                        const servidorSelecionado = selectElement.value; // Valor do servidor selecionado
                        const componenteSelecionado = document
                            .getElementById('select-componente')
                            .querySelector('select')?.value; // Valor do componente selecionado (se existir)

                        console.log('Servidor Selecionado:', servidorSelecionado);
                        console.log('Componente Selecionado:', componenteSelecionado);

                        // Verifica se ambos os valores est√£o definidos antes de chamar a fun√ß√£o
                        if (servidorSelecionado && componenteSelecionado) {
                            criarGrafico(servidorSelecionado, componenteSelecionado);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Houve um erro ao capturar os dados:', error);

                // Exibe uma mensagem de erro
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Erro ao carregar os servidores.';
                errorMessage.style.color = '#ff0000';
                errorMessage.style.textAlign = 'center';
                document.getElementById('select-server').appendChild(errorMessage);
            });
    }

    // Chama a fun√ß√£o para listar os servidores ao carregar a p√°gina
    listarSelect();

    // LISTAGEM DE COMPONENTE
    function listarComponente() {
        fetch(`/previsao/buscarComponente`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Transformando a resposta em JSON
            })
            .then(data => {
                console.log(data); // Verifique no console se a resposta est√° conforme esperado

                const selectDiv = document.getElementById('select-componente');
                selectDiv.innerHTML = ''; // Limpar conte√∫do anterior da div

                if (!data || data.length === 0) {  // Verificar se data √© nulo ou um array vazio
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'Nenhum Registro encontrado.';
                    noDataMessage.style.color = '#fff';
                    noDataMessage.style.textAlign = 'center';
                    selectDiv.appendChild(noDataMessage);
                } else {
                    // Cria o elemento select
                    const selectElement = document.createElement('select');
                    selectElement.classList.add('custom-select'); // Adiciona uma classe CSS, se necess√°rio

                    // Adiciona a op√ß√£o padr√£o
                    selectElement.innerHTML = `<option value="" disabled selected>Selecione um componente</option>`;

                    // Percorrer os dados e adicionar as op√ß√µes
                    data.forEach(item => {
                        // Adicionar uma op√ß√£o ao select
                        selectElement.innerHTML += `
                        <option value="${item.idComponente}">
                            ${item.nome}
                        </option>
                    `;
                    });

                    // Adiciona o select na div
                    selectDiv.appendChild(selectElement);
                    selectElement.addEventListener('change', () => {
                        // Obt√©m os valores selecionados dinamicamente
                        const servidorSelecionado = document
                            .getElementById('select-server')
                            .querySelector('select')?.value; // Valor do servidor selecionado (se existir)
                        const componenteSelecionado = selectElement.value; // Valor do componente selecionado

                        console.log('Servidor Selecionado:', servidorSelecionado);
                        console.log('Componente Selecionado:', componenteSelecionado);

                        // Verifica se ambos os valores est√£o definidos antes de chamar a fun√ß√£o
                        if (servidorSelecionado && componenteSelecionado) {
                            criarGrafico(servidorSelecionado, componenteSelecionado);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Houve um erro ao capturar os dados:', error);

                // Exibe uma mensagem de erro
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Erro ao carregar os servidores.';
                errorMessage.style.color = '#ff0000';
                errorMessage.style.textAlign = 'center';
                document.getElementById('select-componente').appendChild(errorMessage);
            });
    }

    // Chama a fun√ß√£o para listar os servidores ao carregar a p√°gina
    listarComponente();



    async function obterDadosDoBanco(servidorId, componenteId) {
        console.log('servidor:', servidorId)
        console.log('componente:', componenteId)

        try {
            let response = await fetch(`/previsao/buscarTendenciaUsoRam/${componenteId}/${servidorId}`);
            let data = await response.json();  // Convertendo a resposta em JSON
            console.log(data)
            return data;  // Retorna os dados para uso posterior
        } catch (error) {
            console.error('Erro ao obter dados:', error);
            return [];  // Retorna um array vazio em caso de erro
        }
    }


    // Fun√ß√£o de regress√£o linear (j√° explicada anteriormente)
    function calcularRegressao(data) {
        const n = data.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

        data.forEach(point => {
            sumX += point.x;
            sumY += point.y;
            sumXY += point.x * point.y;
            sumXX += point.x * point.x;
        });

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        return { slope, intercept };
    }

    let graficoAtivo = null;
    async function criarGrafico(servidorId, componenteId) {

        const servidorSelecionado = document.querySelector('#select-server select')?.value; // Pega o value do select de servidor
        const componenteSelecionado = document.querySelector('#select-componente select')?.value; // Pega o value do select de componente

        console.log('Servidor Selecionado CRIAR GR√ÅFICO:', servidorSelecionado);
        console.log('Componente Selecionado CRIAR GR√ÅFICO:', componenteSelecionado);

        if (!servidorSelecionado || !componenteSelecionado) {
            return; // N√£o cria o gr√°fico se um dos selects n√£o estiver selecionado }
        }
        const dadosRam = await obterDadosDoBanco(servidorSelecionado, componenteSelecionado);
        const arrayDados = Object.entries(dadosRam).map(([chave, valor]) => `${chave}: ${valor}`);


        // Transforma os dados para o formato necess√°rio (x: dia da semana, y: uso de RAM)
        const scatterData = dadosRam.map((dado, index) => ({
            x: index + 4,  // Usando o √≠ndice como valor de 'x' (dias da semana)
            y: dado.media_uso_ram
        }));

        // Calcula a linha de regress√£o linear
        const { slope, intercept } = calcularRegressao(scatterData);
        console.log("Slope", slope, intercept)

        // Gere os pontos da linha de regress√£o
        const regressionLine = scatterData.map(point => ({
            x: point.x,
            y: slope * point.x + intercept
        }));

        if (graficoAtivo) {
            graficoAtivo.destroy();
        }

        // Para que resetar as configura√ß√µes do card onde est√° o gr√°fico
        const canvasContainer = document.querySelector('.graficoTendencia');
        canvasContainer.innerHTML = '<canvas id="myChart" style="height: 350px; width: 460px;"></canvas>';
        let nomeComponente = componenteSelecionado === '1' ? 'CPU' : 'RAM'; // Usa compara√ß√£o e operador tern√°rio para maior clareza

        // Cria√ß√£o do gr√°fico com Chart.js
        const ctx = document.getElementById('myChart').getContext('2d');
        graficoAtivo = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        color: 'rgba(255, 255, 255, 1)',

                        label: `Uso de ${nomeComponente}`,
                        data: scatterData,
                        backgroundColor: 'red',
                    },
                    {
                        label: 'Tend√™ncia de Uso',
                        data: regressionLine,
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 0.8)',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0  // Remove os pontos da linha de regress√£o
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            color: 'rgba(255, 255, 255, 1)',
                            text: 'Dia da Semana'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 1)',
                            callback: function (value) {
                                const dias = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
                                return dias[value - 1]; // Ajusta para os dias da semana
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 1)', // Cor branca para a linha de grade no eixo X
                        },
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 1)', // Cor branca para a linha de grade no eixo Y
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 1)' // Cor branca para os n√∫meros no eixo Y
                        },
                        title: {
                            display: true,
                            text: `Uso de ${nomeComponente} (%)`,
                            color: 'rgba(255, 255, 255, 1)',
                            font: {
                                size: 15
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: 'rgba(255, 255, 255, 1)',// Cor das letras das legendas
                            font: {
                                size: 16 // Tamanho da fonte
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</html>