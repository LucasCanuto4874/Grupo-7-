<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard com Gráficos</title>
    <link rel="stylesheet" href="css/Dashboard(JoaoLazaro).css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="inicializarGraficos()">

    <div class="NavBar">
        <div><img class="LogoNavBar" src="./assets/Logo Quantum.svg" alt=""></div>
        <div class="div1">
            <a class="botaoNavBar" href="">
                <p>Home</p>
            </a>
            <a class="botaoNavBar" href="">
                <p>Previsões</p>
            </a>
            <a class="botaoNavBar" href="">
                <p>Funcionário</p>
            </a>
            <a class="botaoNavBar" href="">
                <p>Servidor</p>
            </a>
            <a class="botaoNavBar" href="">
                <p>Perfil</p>
            </a>
        </div>
    </div>

    <section class="Monitoramento">
        <!-- <div>
            <h1 class="TituloBem-Vindo">Olá, Usuário!</h1>
            <p class="TituloBem-Vindo">Monitoramento do dia: DD/MM/AAAA</p>
            <p class="Paragrafo_Bem-vindo">Alertas e Informações Por Componente</p>
        </div> -->

        <div class="div1-container">
            <div class="box1">

                <div class="DivComponente">
                    <!-- <h1 class="TituloComponentes">Componentes que passaram <br> do limite, por servidor.</h1> -->

                    <div class="listaServidores">

                        <table id="tabela-servidores">
                            <thead>
                                <tr class="tituloTabela">
                                    <th>Servidor</th>
                                    <th>Componente</th>
                                    <th>Uso(%)</th>
                                    <th>Limite</th>
                                </tr>
                            </thead>
                            <tbody>              
                            </tbody>
                        </table>
                        
                    </div>
                </div>
                
                <div class="DivAlertas"><canvas id="graficoAlerta"></canvas>
                    <!-- <h1 class="tituloAlertas">Números de alerta <br> gerado por componente (Semanal)</h1> -->
                </div>
            </div>

            <div style="margin-top: 110px; margin-left: 190px;">
            <div class="box2">
                <div class="card1">
                    <p class="TotalServidores">Total de servidores <br><br>
                    <div class="textoCard1"></div>
                    </p>
                </div>

                <div class="card1">
                    <p class="TotalServidores">Desativados <br><br>
                    <div class="textoCard2"></div>
                    </p>
                </div>

                <div class="card1">
                    <p class="TotalServidores">Ativados <br><br>
                    <div class="textoCard3"></div>
                    </p>
                </div>
                <!-- <div class="card2"> -->
                    <!-- <div class="tituloQuadrante">Status dos servidores</div> -->
                    <!-- <canvas class="" id="graficoStatus"></canvas> -->
                <!-- </div> -->
            </div>

            <div style="margin-left: -360px; margin-top: -80px;">
            <p class="Titulo_Grafico_CPU">Uso de CPU (%)</p>
            <div class="card3"><canvas id="graficoCPU"></canvas></div>
            <p class="Titulo_Grafico_Memoria">Uso de Memória RAM (%)</p>
            <div class="card4"><canvas id="graficoMemoria"></canvas></div>
            <p class="Titulo_Grafico_Disco">Uso de Disco (%)</p>
            <div class="card5"><canvas id="graficoDisco"></canvas></div>
        </div>
        </div>
    </div>

        </div>
        <!-- <div class="card8"><canvas id="graficoUptime"></canvas></div> -->
        <!-- <div class="card7"><canvas id="graficoStatus"></canvas></div> -->
    </section>

    <script>

        function inicializarGraficos() {
            criarGraficoCPU();
            criarGraficoMemoria();
            criarGraficoDisco();
            criarGraficoUptime();
            criarGraficoAlerta();
            atualizarNumeroServidores();
            buscarNumeroServidoresDesativado();
            buscarNumeroServidoresAtivado();
            carregarComponentesPorServidor();
        }

        function carregarComponentesPorServidor(idServidor) {
    fetch(`/graficosLazaro/ComponentePorServidor:idServidor`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Dados recebidos da API:", data);

            const tabelaServidores = document.getElementById('tabela-servidores').querySelector('tbody');
            tabelaServidores.innerHTML = ""; 

            if (data.length === 0) {
                const linhaVazia = document.createElement('tr');
                linhaVazia.innerHTML = `<td colspan="4">Nenhum componente ultrapassou o limite para este servidor.</td>`;
                tabelaServidores.appendChild(linhaVazia);
            } else {
                
                data.forEach(item => {
                    const { Servidor, Componente, Uso, Limite } = item;

                    const linha = document.createElement('tr');
                    linha.innerHTML = `
                        <th>${item.Servidor || "Desconhecido"}</th>
                        <th>${item.Componente || "Desconhecido"}</th>
                        <th>${item.Uso || 0}%</th>
                        <th>${item.Limite || 0}%</th>
                    `;

                    tabelaServidores.appendChild(linha);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao capturar os dados:', error);
        });
}


function atualizarNumeroServidores() {
    fetch("/graficosLazaro/numeroTotal:idServidor") 
        .then(response => {
            if (!response.ok) {
                throw new Error("Erro ao buscar o número total de servidores");
            }
            return response.json();
        })
        .then(data => {
            
            const totalServidores = data[0]["count(*)"];
            document.querySelector(".textoCard1").textContent = totalServidores;
        })
        .catch(error => {
            console.error("Erro:", error);
        });
}

function buscarNumeroServidoresDesativado() {
    fetch("/graficosLazaro/numeroDesativados:idServidor") 
        .then(response => {
            if (!response.ok) {
                throw new Error("Erro ao buscar o número total de servidores");
            }
            return response.json();
        })
        .then(data => {
            
            const totalServidoresDesativados = data[0].servidores_desativados;
            document.querySelector(".textoCard2").textContent = totalServidoresDesativados;
        })
        .catch(error => {
            console.error("Erro:", error);
        });
}

function buscarNumeroServidoresAtivado() {
    fetch("/graficosLazaro/numeroAtivados:idServidor") 
        .then(response => {
            if (!response.ok) {
                throw new Error("Erro ao buscar o número total de servidores");
            }
            return response.json();
        })
        .then(data => {
            
            const totalServidoresAtivados = data[0].servidores_Ativados;
            document.querySelector(".textoCard3").textContent = totalServidoresAtivados;
        })
        .catch(error => {
            console.error("Erro:", error);
        });
}

        function criarGraficoCPU() {
            fetch(`/graficosLazaro/MediaCPU:idServidor`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        plotarGraficoMediaCPU(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function plotarGraficoMediaCPU(resposta) { 
            console.log('Iniciando plotagem do gráfico com máximos e mínimos por dia...');

function obterDiaDaSemana(data) {
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    const dia = new Date(data);
    return diasSemana[dia.getDay()];  
}

let labels = [];
let maxValues = [];
let minValues = [];

resposta.forEach((registro) => {
    const diaDaSemana = obterDiaDaSemana(registro.dia);
    labels.push(diaDaSemana); 
    maxValues.push(registro.maxUsoCPU); 
    minValues.push(registro.minUsoCPU); 
});

let dadosCPU = {
    labels: labels,
    datasets: [
        {
            label: 'Uso Máximo da CPU',
            data: maxValues,
            backgroundColor: 'white', 
            borderColor: 'white',
            borderWidth: 1
        },
        {
            label: 'Uso Mínimo da CPU',
            data: minValues,
            backgroundColor: '#2f2258',
            borderColor: 'white',
            borderWidth: 1
        }
    ]
};

const config = {
    type: 'bar',
    data: dadosCPU,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Uso de CPU Máximo e Mínimo por Dia',
                color: 'white',
                font: {
                    size: 20
                }
            },
            legend: {
                labels: {
                    color: 'white',
                    font: {
                        size: 14
                    }
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: 'white'
                }
            },
            y: {
                ticks: {
                    color: 'white',
                    callback: function (value) { return value + '%' }
                },
                max: 100,
            }
        }
    }
};

let myChart = new Chart(
    document.getElementById(`graficoCPU`),
    config
);
        }

        function criarGraficoMemoria() {
            fetch(`/graficosLazaro/MediaRAM:idServidor`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        plotarGraficoMediaRAM(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function plotarGraficoMediaRAM(resposta) {
            console.log('iniciando plotagem do gráfico...');

            let labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
            let dadosCPU = {
                labels: labels,
                datasets: [
                    {
                        label: 'Média RAM',
                        data: [],
                        backgroundColor: '#2f2258',
                        borderColor: 'white',
                        borderWidth: 1
                    }
                ]
            };

            console.log('----------------------------------------------');
            console.log('Estes dadosCPU foram recebidos pela funcao "obterdadosCPUGrafico" e passados para "plotarGraficoPeso":');
            console.log(resposta);

            resposta.forEach((registro) => {
                console.log(registro); 
                dadosCPU.datasets[0].data.push(registro.mediaUsoRAM);
            });


            console.log('----------------------------------------------');
            console.log('O gráfico será plotado com os respectivos valores:');
            console.log('Labels:', labels);
            console.log('dadosCPU:', dadosCPU.datasets);
            console.log('----------------------------------------------');

            const config = {
                type: 'bar',
                data: dadosCPU,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Uso de RAM Semanal',
                            color: 'white',
                            font: {
                                size: 20
                            }
                        },
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white',
                                callback: function (value) { return value + '%' }
                            },
                            max: 100,
                        }
                    }
                }
            };

            let myChart = new Chart(
                document.getElementById(`graficoMemoria`),
                config
            );
        }

        function criarGraficoDisco() {
            fetch(`/graficosLazaro/MediaDisco:idServidor`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        plotarGraficoMediaDisco(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function plotarGraficoMediaDisco(resposta) { 
            console.log('iniciando plotagem do gráfico...');

            let labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
            let dadosCPU = {
                labels: labels,
                datasets: [
                    {
                        label: 'Média RAM',
                        data: [],
                        backgroundColor: '#2f2258',
                        borderColor: 'white',
                        borderWidth: 1
                    }
                ]
            };

            console.log('----------------------------------------------');
            console.log('Estes dadosCPU foram recebidos pela funcao "obterdadosCPUGrafico" e passados para "plotarGraficoPeso":');
            console.log(resposta);

            resposta.forEach((registro) => {
                console.log(registro);
                dadosCPU.datasets[0].data.push(registro.mediaUsoDisco);
            });


            console.log('----------------------------------------------');
            console.log('O gráfico será plotado com os respectivos valores:');
            console.log('Labels:', labels);
            console.log('dadosCPU:', dadosCPU.datasets);
            console.log('----------------------------------------------');

            const config = {
                type: 'bar',
                data: dadosCPU,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Uso de Disco Semanal',
                            color: 'white',
                            font: {
                                size: 20
                            }
                        },
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white',
                                callback: function (value) { return value + '%' }
                            },
                            max: 100,
                        }
                    }
                }
            };

            let myChart = new Chart(
                document.getElementById(`graficoDisco`),
                config
            );
        }

        function criarGraficoAlerta() {
            fetch(`/graficosLazaro/alertasPorComponente:idServidor`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        plotarGraficoAlertas(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function plotarGraficoAlertas(resposta) { 
            console.log('iniciando plotagem do gráfico...');

            let labels = ['CPU', 'RAM', 'Disco'];
            let dadosCPU = {
                labels: labels,
                datasets: [
                    {
                        label: 'Média RAM',
                        data: [],
                        backgroundColor: '#2f2258',
                        borderColor: 'white',
                        borderWidth: 1
                    }
                ]
            };

            console.log('----------------------------------------------');
            console.log('Estes dadosCPU foram recebidos pela funcao "obterdadosCPUGrafico" e passados para "plotarGraficoPeso":');
            console.log(resposta);

            resposta.forEach((registro) => {
                console.log(registro);  
                dadosCPU.datasets[0].data.push(registro.total_alertas);
            });


            console.log('----------------------------------------------');
            console.log('O gráfico será plotado com os respectivos valores:');
            console.log('Labels:', labels);
            console.log('dadosCPU:', dadosCPU.datasets);
            console.log('----------------------------------------------');

            const config = {
                type: 'bar',
                data: dadosCPU,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Quantidade de alerta por componente',
                            color: 'white',
                            font: {
                                size: 20
                            }
                        },
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            max: 30,
                        }
                    }
                }
            };

            let myChart = new Chart(
                document.getElementById(`graficoAlerta`),
                config
            );
        }

        function criarGraficoUptime() {

            fetch(`/graficosLazaro/uptime:idServidor`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        plotarGraficoUptime(resposta);

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        let myChartUptime;

        function plotarGraficoUptime(resposta) {
            console.log('iniciando plotagem do gráfico...');

            if (myChartUptime) {
                myChartUptime.destroy();
            }


            let labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
            let dados = {
                labels: labels,
                datasets: [
                    {
                        label: 'Servidor 1 - Uptime (%)',
                        data: [],
                        backgroundColor: '#2f2258',
                        borderColor: 'white',   
                        borderWidth: 1
                    },
                    {
                        label: 'Servidor 2 - Uptime (%)',
                        data: [],
                        backgroundColor: '#6743a5',
                        borderColor: 'white',
                        borderWidth: 1
                    },
                    {
                        label: 'Servidor 3 - Uptime (%)',
                        data: [],
                        backgroundColor: 'white',
                        borderColor: 'white',
                        borderWidth: 1
                    }
                ]
            };

            console.log('----------------------------------------------');
            console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGraficoPeso":');
            console.log(resposta);


            resposta.forEach((registro) => {
                dados.datasets[0].data.push(registro.uptime_percent);
                dados.datasets[1].data.push(registro.uptime_percent);
                dados.datasets[2].data.push(registro.uptime_percent);
            });

            console.log('----------------------------------------------');
            console.log('O gráfico será plotado com os respectivos valores:');
            console.log('Labels:', labels);
            console.log('Dados:', dados.datasets);
            console.log('----------------------------------------------');


            const config = {
                type: 'bar',
                data: dados,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Uptime Semanal dos Servidores',
                            color: 'white',
                            font: {
                                size: 20
                            }
                        },
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white',
                                callback: function (value) { return value + '%' }
                            },
                            max: 100,
                        }
                    }
                }
            };

            myChartUptime = new Chart(document.getElementById('graficoUptime'), config);
        }


    </script>

</body>

</html>